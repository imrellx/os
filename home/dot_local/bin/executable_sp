#!/usr/bin/env zsh
# ABOUTME: SSH host picker with fzf and tmux integration
# ABOUTME: Standalone script for use in tmux popups

# Debug mode: set SP_DEBUG=1 to see what's happening
if [[ -n "$SP_DEBUG" ]]; then
    exec 2>/tmp/sp-debug.log
    set -x
fi

SSH_CONFIG_DIR="${SSH_CONFIG_DIR:-$HOME/.ssh/config.d}"
HOSTS_FILE="/tmp/sp-hosts-$$"
DISPLAY_FILE="/tmp/sp-display-$$"

cleanup() {
    [[ -z "$SP_DEBUG" ]] && rm -f "$HOSTS_FILE" "$DISPLAY_FILE"
}
trap cleanup EXIT

# Verify config dir exists
if [[ ! -d "$SSH_CONFIG_DIR" ]]; then
    print "Error: SSH config directory not found: $SSH_CONFIG_DIR"
    read -k1 -s
    exit 1
fi

# Parse SSH configs into hosts file
for file in "$SSH_CONFIG_DIR"/*; do
    [[ -f "$file" ]] || continue
    [[ "$(basename "$file")" == "00-defaults" ]] && continue
    [[ "$(basename "$file")" == "05-github" ]] && continue

    current_host=""
    current_ip=""
    current_op=""

    while IFS= read -r line; do
        [[ -z "$line" ]] && continue
        [[ "$line" == \#* && "$line" != *"# OP:"* ]] && continue

        if [[ "$line" == Host\ * ]]; then
            if [[ -n "$current_host" && -n "$current_ip" ]]; then
                print -r -- "${current_host}|${current_ip}|${current_op}" >> "$HOSTS_FILE"
            fi
            current_host="${line#Host }"
            current_host="${current_host%% *}"
            [[ "$current_host" == *\** ]] && { current_host=""; continue; }
            current_ip=""
            current_op=""
        elif [[ "$line" == *HostName\ * ]]; then
            current_ip="${line#*HostName }"
            current_ip="${current_ip%% *}"
        elif [[ "$line" == *"# OP:"* ]]; then
            current_op="${line#*\# OP: }"
            current_op="${current_op%% *}"
        fi
    done < "$file"

    if [[ -n "$current_host" && -n "$current_ip" ]]; then
        print -r -- "${current_host}|${current_ip}|${current_op}" >> "$HOSTS_FILE"
    fi
done

# Check we have hosts
if [[ ! -s "$HOSTS_FILE" ]]; then
    print "No SSH hosts found in $SSH_CONFIG_DIR"
    print "Files checked:"
    ls -la "$SSH_CONFIG_DIR"
    read -k1 -s
    exit 1
fi

host_count=$(wc -l < "$HOSTS_FILE" | tr -d ' ')

# Create display list
while IFS='|' read -r host ip op; do
    print -r -- "$host ($ip)"
done < "$HOSTS_FILE" > "$DISPLAY_FILE"

# Run fzf with explicit input
fzf_result=$(/opt/homebrew/bin/fzf \
    --multi \
    --reverse \
    --border=rounded \
    --border-label=" SSH Hosts ($host_count) " \
    --prompt='  ' \
    --pointer='▶' \
    --marker='✓' \
    --query="${1:-}" \
    --preview="h=\$(echo {} | cut -d' ' -f1); grep -h \"^Host \$h\$\" -A10 $SSH_CONFIG_DIR/* 2>/dev/null | head -12" \
    --preview-window='right:40%:wrap' \
    --header='Enter: window | C-t: tiled | C-s: sync | Tab: multi' \
    --expect='ctrl-t,ctrl-s' \
    < "$DISPLAY_FILE"
) || exit 0

[[ -z "$fzf_result" ]] && exit 0

# Parse result
key_pressed=$(print -r -- "$fzf_result" | head -1)
selected_hosts=$(print -r -- "$fzf_result" | tail -n +2 | cut -d' ' -f1)

[[ -z "$selected_hosts" ]] && exit 0

# Determine layout
case "$key_pressed" in
    ctrl-t) layout="tiled" ;;
    ctrl-s) layout="sync" ;;
    *)      layout="window" ;;
esac

sel_count=$(print -r -- "$selected_hosts" | wc -l | tr -d ' ')

# Helper to get OP ref
get_op() {
    grep "^${1}|" "$HOSTS_FILE" | cut -d'|' -f3
}

# Helper to build command
build_cmd() {
    local h="$1" o="$2"
    if [[ -n "$o" ]]; then
        print -r -- "zsh -c 'sshpass -d 3 3< <(op read \"$o\") ssh $h || read -k1 -s'"
    else
        print -r -- "ssh $h || read -k1 -s"
    fi
}

# Execute
if [[ "$layout" == "window" && "$sel_count" -eq 1 ]]; then
    h=$(print -r -- "$selected_hosts" | head -1)
    cmd=$(build_cmd "$h" "$(get_op "$h")")
    tmux new-window -n "$h" "$cmd"
else
    first=true
    print -r -- "$selected_hosts" | while IFS= read -r h; do
        cmd=$(build_cmd "$h" "$(get_op "$h")")
        if $first; then
            tmux new-window -n "ssh-${layout}" "$cmd"
            first=false
        else
            tmux split-window "$cmd"
            tmux select-layout tiled
        fi
    done
    [[ "$layout" == "sync" ]] && tmux set-window-option synchronize-panes on
fi
