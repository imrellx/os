# ABOUTME: Homebrew configuration and update functions
# ABOUTME: Cross-platform template for macOS and Linux
# ~/.config/zsh/homebrew.zsh
# DOCS https://docs.brew.sh/Manpage#environment
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{{- if eq .chezmoi.os "darwin" }}
export HOMEBREW_CASK_OPTS="--no-quarantine"
export HOMEBREW_UPGRADE_GREEDY_CASKS="obsidian microsoft-teams microsoft-word"
export HOMEBREW_EDITOR="open"
{{- else }}
export HOMEBREW_EDITOR="${EDITOR:-vim}"
{{- end }}

# Brewfile locations (in os repo inventory folder)
export BREWFILE_DIR="$HOME/Code/personal/os/inventory"
export BREWFILE_COMMON="$BREWFILE_DIR/Brewfile.common"
{{- if eq .chezmoi.os "darwin" }}
export BREWFILE_PLATFORM="$BREWFILE_DIR/Brewfile.darwin"
{{- else }}
export BREWFILE_PLATFORM="$BREWFILE_DIR/Brewfile.linux"
{{- end }}

export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_ENV_HINTS=1
export HOMEBREW_DISPLAY_INSTALL_TIMES=1

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _pretty_header() {
	[[ "$2" != "no-line-break" ]] && echo
{{- if eq .chezmoi.os "darwin" }}
	defaults read -g AppleInterfaceStyle &> /dev/null && fg="\e[1;30m" || fg="\e[1;37m"
{{- else }}
	# On Linux, assume dark terminal
	fg="\e[1;37m"
{{- end }}
	bg="\e[1;44m"
	print "$fg$bg $1 \e[0m"
}

function _brew_bundle_install() {
	local brewfile="$1"
	local name="$2"
	if [[ ! -f "$brewfile" ]]; then
		echo "âš ï¸  $name not found: $brewfile"
		return 1
	fi
	if ! brew bundle check --file="$brewfile" --no-upgrade &> /dev/null; then
		export HOMEBREW_COLOR=1
		brew bundle install --file="$brewfile" --verbose --no-upgrade |
			grep --invert-match --extended-regexp "^Using |^Skipping install of "
	else
		echo "âœ… $name satisfied."
	fi
}

function update() {
	_pretty_header "brew update" "no-line-break"
	brew update

	_pretty_header "brew bundle install (common)"
	_brew_bundle_install "$BREWFILE_COMMON" "Brewfile.common"

	_pretty_header "brew bundle install (platform)"
	_brew_bundle_install "$BREWFILE_PLATFORM" "Brewfile.platform"

	_pretty_header "brew upgrade"
	if [[ -n $(brew outdated) ]]; then
		brew upgrade
	else
		echo "âœ… Already up-to-date."
	fi

{{- if eq .chezmoi.os "darwin" }}
	_pretty_header "mas upgrade"
	if [[ -n $(mas outdated) ]]; then
		mas upgrade
	else
		echo "âœ… Already up-to-date."
	fi
{{- end }}

	# 10% of the time, run `brew doctor`
	if ((RANDOM % 100 < 10)); then
		_pretty_header "brew doctor"
		brew doctor
	fi

	echo "ðŸº Homebrew update finished."
}
